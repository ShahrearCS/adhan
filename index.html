<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Adhan</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="icon" href="favicon.png" type="image/png">

  <style>
    :root {
      --primary: #009688; /* teal green */
      --success: #26a69a;
      --bg: #121212;
      --card: #1e1e1e;
      --text: #e0e0e0;
    }
    [data-theme="light"] {
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #212529;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      line-height: 1.6;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 2.3rem;
      color: var(--primary);
    }
    .location {
      text-align: center;
      font-size: 1.1rem;
      margin: 10px 0 20px;
      color: var(--success);
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      margin-bottom: 20px;
    }
    .prayer {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 1.2rem;
    }
    .prayer:last-child { border-bottom: none; }
    .prayer.now {
      background: rgba(0,150,136,0.15);
      border-radius: 8px;
    }
    .next-prayer {
      text-align: center;
      margin: 15px 0;
      font-size: 1.3rem;
      color: var(--primary);
      font-weight: bold;
    }
    .countdown {
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--success);
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 50px;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.3s;
    }
    button:hover { opacity: 0.9; }
    .theme-toggle {
      position: fixed;
      top: 15px;
      right: 15px;
      background: var(--card);
      padding: 10px;
      border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer;
      font-size: 1.3rem;
    }
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.1rem;
      color: #888;
    }
    .github-link {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      color: var(--text);
      font-size: 18px;
      transition: color 0.3s;
    }
    .github-link:hover { color: var(--primary); }
    .github-link i { margin-right: 8px; font-size: 24px; }
  </style>
</head>
<body data-theme="dark">
  <div class="theme-toggle" onclick="toggleTheme()">
    <i class="fas fa-sun"></i>
  </div>

  <div class="container">
    <div class="header">
      <h1><i class="fas fa-mosque"></i> Adhan</h1>
    </div>

    <div id="location" class="location">Detecting location...</div>
    <div id="loading" class="loading"><i class="fas fa-pray fa-3x"></i><br><br>Loading prayer times...</div>

    <div id="prayers" class="card" style="display:none;">
      <div id="nextPrayer" class="next-prayer"></div>
      <div id="countdown" class="countdown">--:--:--</div>

      <div class="prayer"><span class="name">Fajr</span> <span id="fajr">--:--</span></div>
      <div class="prayer"><span class="name">Dhuhr</span> <span id="dhuhr">--:--</span></div>
      <div class="prayer"><span class="name">Asr</span> <span id="asr">--:--</span></div>
      <div class="prayer"><span class="name">Maghrib</span> <span id="maghrib">--:--</span></div>
      <div class="prayer"><span class="name">Isha</span> <span id="isha">--:--</span></div>
    </div>

    <div class="controls">
      <button onclick="getLocation()"><i class="fas fa-location-arrow"></i> Refresh</button>
    </div>

    <div style="text-align:center; margin-top:30px; font-size:0.9rem; color:#777;">
      Powered by Aladhan API • Created by Shahrear Chowdhury
    </div>
    <div style="text-align:center;">
      <a class="github-link" href="https://github.com/ShahrearCS" target="_blank">
        <i class="fab fa-github"></i> GitHub
      </a>
    </div>
  </div>

  <audio id="adhanAudio" preload="auto">
    <source src="https://download.quranicaudio.com/athan/Alafasy/athan1.mp3" type="audio/mp3"/>
  </audio>

  <script>
    let timings24h = {};
    let countdownInterval;

    // Apply stored theme or default to dark
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.setAttribute('data-theme', savedTheme);
    const themeIcon = document.querySelector('.theme-toggle i');
    themeIcon.classList.replace('fa-moon', savedTheme === 'dark' ? 'fa-sun' : 'fa-moon');

    function toggleTheme() {
      const current = document.body.getAttribute('data-theme');
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      themeIcon.classList.replace(newTheme === 'dark' ? 'fa-moon' : 'fa-sun', newTheme === 'dark' ? 'fa-sun' : 'fa-moon');
      localStorage.setItem('theme', newTheme);
    }

    function getLocation() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('prayers').style.display = 'none';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(fetchPrayerTimes, showError);
      } else {
        document.getElementById('location').innerText = "Geolocation not supported.";
      }
    }

    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('location').innerText = "Unable to get location.";
    }

    async function fetchPrayerTimes(position) {
      const lat = position.coords.latitude.toFixed(3);
      const lng = position.coords.longitude.toFixed(3);
      const today = new Date().toISOString().slice(0,10);
      const cacheKey = `prayers_${lat}_${lng}_${today}`;
      const cached = localStorage.getItem(cacheKey);

      if (cached) {
        const data = JSON.parse(cached);
        renderPrayerTimes(data, lat, lng);
        return;
      }

      const response = await fetch(`https://api.aladhan.com/v1/timings/${today}?latitude=${lat}&longitude=${lng}&method=2`);
      const data = await response.json();
      if (data.code === 200) {
        localStorage.setItem(cacheKey, JSON.stringify(data.data));
        renderPrayerTimes(data.data, lat, lng);
      }
    }

    async function renderPrayerTimes(data, lat, lng) {
      const t = data.timings;
      timings24h = { Fajr: t.Fajr, Dhuhr: t.Dhuhr, Asr: t.Asr, Maghrib: t.Maghrib, Isha: t.Isha };
      await getCityName(lat, lng);

      for (let key in timings24h) {
        const el = document.getElementById(key.toLowerCase());
        if (el) el.textContent = to12Hour(timings24h[key]);
      }

      document.getElementById('loading').style.display = 'none';
      document.getElementById('prayers').style.display = 'block';
      startCountdown();
    }

    async function getCityName(lat, lng) {
      try {
        const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
        const info = await res.json();
        const city = info.city || info.locality || info.principalSubdivision || "Unknown";
        document.getElementById('location').innerHTML =
          `<i class="fas fa-map-marker-alt"></i> ${city}, ${info.countryName} • ${new Date().toLocaleDateString()}`;
      } catch {
        document.getElementById('location').innerHTML =
          `<i class="fas fa-map-marker-alt"></i> Location unavailable • ${new Date().toLocaleDateString()}`;
      }
    }

    function to12Hour(time) {
      let [h, m] = time.split(':').map(Number);
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${m.toString().padStart(2,'0')} ${ampm}`;
    }

    function startCountdown() {
      clearInterval(countdownInterval);
      countdownInterval = setInterval(updateCountdownDisplay, 1000);
      updateCountdownDisplay();
    }

    function updateCountdownDisplay() {
      const now = new Date();
      let nextPrayer = null, minDiff = Infinity;

      for (let p in timings24h) {
        let [h, m] = timings24h[p].split(':').map(Number);
        let t = new Date(); t.setHours(h, m, 0, 0);
        if (t < now) t.setDate(t.getDate() + 1);
        let diff = (t - now) / 1000;
        if (diff < minDiff) { minDiff = diff; nextPrayer = p; }
      }

      if (!nextPrayer) nextPrayer = 'Fajr';
      document.querySelectorAll('.prayer').forEach(p => p.classList.remove('now'));
      const active = Array.from(document.querySelectorAll('.prayer')).find(p => p.querySelector('.name').textContent.includes(nextPrayer));
      if (active) active.classList.add('now');

      const h = Math.floor(minDiff / 3600);
      const m = Math.floor((minDiff % 3600) / 60);
      const s = Math.floor(minDiff % 60);
      document.getElementById('nextPrayer').innerHTML = `<i class="fas fa-clock"></i> Next: ${nextPrayer} in`;
      document.getElementById('countdown').textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    window.onload = () => { getLocation(); };
  </script>
</body>
</html>

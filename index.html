<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Adhan App - Fast Prayer Times</title>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" media="print" onload="this.media='all'">
  <style>
    :root {
      --primary: #009688; /* better teal shade */
      --success: #26a69a;
      --bg: #121212;
      --card: #1e1e1e;
      --text: #e0e0e0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 500px;
      margin: 20px auto;
      padding: 20px;
    }
    .header { text-align: center; margin-bottom: 25px; }
    .header h1 { color: var(--primary); font-size: 2.2rem; }
    .location {
      text-align: center;
      font-size: 1.1rem;
      margin: 10px 0;
      color: var(--success);
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.25);
      margin-bottom: 15px;
    }
    .prayer {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #333;
      font-size: 1.2rem;
    }
    .prayer:last-child { border-bottom: none; }
    .prayer.now {
      background: rgba(0,150,136,0.15);
      border-radius: 8px;
      padding: 12px;
    }
    .next-prayer {
      text-align: center;
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--primary);
      margin: 10px 0;
    }
    .countdown {
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      color: var(--success);
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 15px 0;
    }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 40px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      transition: opacity 0.3s;
    }
    button:hover { opacity: 0.9; }
    .theme-toggle {
      position: fixed;
      top: 18px;
      right: 18px;
      background: var(--card);
      padding: 10px;
      border-radius: 50%;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      font-size: 1.3rem;
    }
    .loading {
      text-align: center;
      padding: 35px;
      font-size: 1.1rem;
      color: #aaa;
    }
    .footer {
      text-align: center;
      font-size: 0.85rem;
      color: #777;
      margin-top: 25px;
    }
  </style>
</head>
<body data-theme="dark">
  <div class="theme-toggle" onclick="toggleTheme()">
    <i class="fas fa-sun"></i>
  </div>

  <div class="container">
    <div class="header">
      <h1><i class="fas fa-mosque"></i> Adhan App</h1>
    </div>

    <div id="location" class="location">Detecting location...</div>

    <div id="loading" class="loading">
      <i class="fas fa-pray fa-3x"></i><br><br>Loading prayer times...
    </div>

    <div id="prayers" class="card" style="display:none;">
      <div id="nextPrayer" class="next-prayer"></div>
      <div id="countdown" class="countdown">--:--:--</div>
      <div class="prayer"><span class="name">Fajr</span><span id="fajr">--:--</span></div>
      <div class="prayer"><span class="name">Dhuhr</span><span id="dhuhr">--:--</span></div>
      <div class="prayer"><span class="name">Asr</span><span id="asr">--:--</span></div>
      <div class="prayer"><span class="name">Maghrib</span><span id="maghrib">--:--</span></div>
      <div class="prayer"><span class="name">Isha</span><span id="isha">--:--</span></div>
    </div>

    <div class="controls">
      <button onclick="playAdhan()"><i class="fas fa-play"></i> Play Adhan</button>
      <button onclick="getLocation(true)"><i class="fas fa-sync"></i> Refresh</button>
    </div>

    <div class="footer">
      Powered by Aladhan API • Created by Shahrear Chowdhury
      <br>
      <a href="https://github.com/ShahrearCS" target="_blank" style="color:#ccc;text-decoration:none;">
        <i class="fab fa-github"></i> GitHub
      </a>
    </div>
  </div>

  <audio id="adhanAudio" preload="none">
    <source src="https://download.quranicaudio.com/athan/Alafasy/athan1.mp3" type="audio/mp3"/>
  </audio>

  <script>
    let timings24h = {};
    let countdownInterval;
    const CACHE_KEY = "adhan_cache";

    // Theme toggle
    function toggleTheme() {
      const body = document.body;
      const icon = document.querySelector('.theme-toggle i');
      if (body.dataset.theme === "dark") {
        body.removeAttribute('data-theme');
        icon.classList.replace('fa-sun', 'fa-moon');
        localStorage.setItem('theme', 'light');
      } else {
        body.dataset.theme = "dark";
        icon.classList.replace('fa-moon', 'fa-sun');
        localStorage.setItem('theme', 'dark');
      }
    }

    if (localStorage.getItem('theme') !== 'light') {
      document.body.dataset.theme = "dark";
      document.querySelector('.theme-toggle i').classList.replace('fa-moon', 'fa-sun');
    }

    // Use cache if available
    function getLocation(forceRefresh = false) {
      const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
      const today = new Date().toISOString().slice(0, 10);

      if (cached && cached.date === today && !forceRefresh) {
        displayPrayerData(cached);
      } else {
        document.getElementById('loading').style.display = 'block';
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => fetchPrayerTimes(pos, today), showError);
        } else {
          document.getElementById('location').innerHTML = "Geolocation not supported";
        }
      }
    }

    async function fetchPrayerTimes(position, date) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const url = `https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lng}&method=2`;

      try {
        const res = await fetch(url, { cache: "force-cache" });
        const data = await res.json();
        if (data.code === 200) {
          const prayerData = {
            date,
            meta: data.data.meta,
            timings: data.data.timings
          };
          localStorage.setItem(CACHE_KEY, JSON.stringify(prayerData));
          displayPrayerData(prayerData);
        }
      } catch {
        document.getElementById('location').innerText = "Failed to load data";
      }
    }

    function displayPrayerData(data) {
      const timings = data.timings;
      const meta = data.meta;

      timings24h = {
        Fajr: timings.Fajr,
        Dhuhr: timings.Dhuhr,
        Asr: timings.Asr,
        Maghrib: timings.Maghrib,
        Isha: timings.Isha
      };

      document.getElementById('location').innerHTML =
        `<i class="fas fa-map-marker-alt"></i> ${meta.timezone} • ${new Date().toLocaleDateString()}`;

      for (let key in timings24h) {
        const el = document.getElementById(key.toLowerCase());
        if (el) el.textContent = to12Hour(timings24h[key]);
      }

      document.getElementById('loading').style.display = 'none';
      document.getElementById('prayers').style.display = 'block';
      startCountdown();
    }

    function to12Hour(time) {
      let [h, m] = time.split(':').map(Number);
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${m.toString().padStart(2, '0')} ${ampm}`;
    }

    function startCountdown() {
      clearInterval(countdownInterval);
      updateCountdownDisplay();
      countdownInterval = setInterval(updateCountdownDisplay, 1000);
    }

    function updateCountdownDisplay() {
      const now = new Date();
      let nextPrayer = null, minDiff = Infinity;

      for (let p in timings24h) {
        const [h, m] = timings24h[p].split(':').map(Number);
        const prayerTime = new Date();
        prayerTime.setHours(h, m, 0, 0);
        if (prayerTime < now) prayerTime.setDate(prayerTime.getDate() + 1);
        const diff = (prayerTime - now) / 1000;
        if (diff < minDiff) { minDiff = diff; nextPrayer = p; }
      }

      if (!nextPrayer) nextPrayer = "Fajr";

      document.querySelectorAll('.prayer').forEach(p => p.classList.remove('now'));
      const active = [...document.querySelectorAll('.prayer')]
        .find(p => p.querySelector('.name').textContent.includes(nextPrayer));
      if (active) active.classList.add('now');

      const h = Math.floor(minDiff / 3600);
      const m = Math.floor((minDiff % 3600) / 60);
      const s = Math.floor(minDiff % 60);

      document.getElementById('nextPrayer').innerHTML = `<i class="fas fa-clock"></i> Next: ${nextPrayer}`;
      document.getElementById('countdown').textContent =
        `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function playAdhan() {
      const audio = document.getElementById('adhanAudio');
      audio.play().catch(() => alert("Click once to allow audio playback"));
    }

    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('location').innerText = "Location access denied.";
    }

    window.onload = () => getLocation();
  </script>
</body>
</html>
